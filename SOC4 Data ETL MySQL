### SOC4 Data ETL 

-- Run script once csv is updated to update fact table with new monthly data 
-- Ensure month column is unpivoted in csv prior to loading in
-- Refer to SOC4 Data import, prep and modelling for commentary points 

set global local_infile=on;

create table staging_table (
Region varchar(250),
`SOC 4 digit code` varchar(250),
`SOC 4 digit label` varchar(250),
MonthYear varchar(250),
`Value` varchar(250)
);

load data local infile 'C:/Users/CalumBrown/OneDrive - Blend 360/Documents/Personal Development/UK Labour Market/Labour_market_staging.csv' into table staging_table
fields terminated by ','
enclosed by '"'
lines terminated by '\r\n'
ignore 1 lines;

update staging_table 
set `Value` = null
WHERE `Value` NOT REGEXP '^[0-9]+$';  -- set any non number values to null 

alter table staging_table 
modify column `Value` int;

UPDATE staging_table t
JOIN (
    SELECT 
        `Region`,
        `SOC 4 digit label`,
        AVG(`Value`) AS avg_value
    FROM staging_table
    WHERE `Value` IS NOT NULL
    GROUP BY `Region`, `SOC 4 digit label`
) AS sub                                                
ON t.`Region` = sub.`Region` 
   AND t.`SOC 4 digit label` = sub.`SOC 4 digit label`
SET t.`Value` = sub.avg_value
WHERE t.`Value` IS NULL;         

delete from staging_table 
where Region = 'Total UK';        

update staging_table
set MonthYear = replace(MonthYear, 'Jan-', '01');
update staging_table
set MonthYear = replace(MonthYear, 'Feb-', '02');
update staging_table
set MonthYear = replace(MonthYear, 'Mar-', '03');
update staging_table
set MonthYear = replace(MonthYear, 'Apr-', '04');
update staging_table
set MonthYear = replace(MonthYear, 'May-', '05');
update staging_table
set MonthYear = replace(MonthYear, 'Jun-', '06');
update staging_table
set MonthYear = replace(MonthYear, 'Jul-', '07');
update staging_table
set MonthYear = replace(MonthYear, 'Aug-', '08');
update staging_table
set MonthYear = replace(MonthYear, 'Sep-', '09');
update staging_table
set MonthYear = replace(MonthYear, 'Oct-', '10');
update staging_table
set MonthYear = replace(MonthYear, 'Nov-', '11');
update staging_table
set MonthYear = replace(MonthYear, 'Dec-', '12');

update staging_table 
set MonthYear = concat(
	'20',
    right(MonthYear, 2),
    left(MonthYear, 2)
    );
    

alter table staging_table
modify column MonthYear int;

create index stagingtableregion on staging_table(Region);
create index stagingtableindustry on staging_table(`SOC 4 digit label`);


alter table staging_table 
add column regionkey int,
add column soc4_id int;

update staging_table as f
join soc4regionaldim as d
on f.Region = d.Region
set f.regionkey = d.regionkey;

update staging_table as f
join soc4industrydim as d
on f.`SOC 4 digit label` = d.`SOC 4 digit label`
set f.soc4_id = d.soc4_id;

alter table staging_table 
drop column Region,
drop column `SOC 4 digit code`,
drop column `SOC 4 digit label`;

insert into soc4fact (MonthYear, `Value`, regionkey, soc4_id)
select MonthYear, `Value`, regionkey, soc4_id
from staging_table;

drop table staging_table;
